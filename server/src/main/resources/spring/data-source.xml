<?xml version="1.0" encoding="UTF-8" ?>
<beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns="http://www.springframework.org/schema/beans"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/util https://www.springframework.org/schema/util/spring-util.xsd
       http://www.springframework.org/schema/tx https://www.springframework.org/schema/tx/spring-tx.xsd">

    <bean id="databaseUrlModifier" class="org.cloudfoundry.identity.uaa.db.DatabaseUrlModifier">
        <constructor-arg name="databaseType" value="#{@platform}"/>
        <constructor-arg name="url" value="${database.url}"/>
        <property name="connectTimeoutSeconds" value="${database.connecttimeout:10}"/>
    </bean>

    <bean id="dataSource" class="org.apache.tomcat.jdbc.pool.DataSource" destroy-method="close">
        <property name="driverClassName" value="${database.driverClassName}"/>
        <property name="url" value="#{@databaseUrlModifier.getUrl()}"/>
        <property name="username" value="${database.username}"/>
        <property name="password" value="${database.password}"/>
        <property name="validationInterval" value="${database.validationinterval:5000}"/>
        <property name="validationQuery" value="#{@validationQuery}"/>
        <property name="testOnBorrow" value="true"/>
        <property name="testWhileIdle" value="${database.testwhileidle:false}"/>
        <property name="minIdle" value="${database.minidle:10}"/>
        <property name="maxActive" value="${database.maxactive:100}"/>
        <property name="maxIdle" value="${database.maxidle:100}"/>
        <property name="maxWait" value="${database.maxwait:30000}"/>
        <property name="initialSize" value="${database.initialsize:10}"/>
        <property name="validationQueryTimeout" value="${database.validationquerytimeout:10}"/>
        <property name="removeAbandoned" value="${database.removeabandoned:false}"/>
        <property name="logAbandoned" value="${database.logabandoned:true}"/>
        <property name="removeAbandonedTimeout" value="${database.abandonedtimeout:300}"/>
        <property name="timeBetweenEvictionRunsMillis" value="${database.evictionintervalms:15000}"/>
        <property name="minEvictableIdleTimeMillis" value="${database.minevictionidlems:60000}"/>
        <property name="jdbcInterceptors" value="org.cloudfoundry.identity.uaa.metrics.QueryFilter(threshold=3000)"/>
    </bean>

    <bean id="dataSourceAccessor" class="org.cloudfoundry.identity.uaa.db.DataSourceAccessor" depends-on="dataSource">
        <property name="dataSource" ref="dataSource"/>
    </bean>

    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>

    <tx:annotation-driven transaction-manager="transactionManager"/>

    <bean class="org.springframework.jmx.export.MBeanExporter">
        <property name="server" ref="mbeanServer"/>
        <property name="registrationPolicy">
            <util:constant static-field="org.springframework.jmx.support.RegistrationPolicy.REPLACE_EXISTING"/>
        </property>
        <property name="beans">
            <map>
                <entry key="spring.application:type=DataSource,name=dataSource" value-ref="dataSource"/>
            </map>
        </property>
        <property name="assembler">
            <bean class="org.springframework.jmx.export.assembler.MethodNameBasedMBeanInfoAssembler">
                <property name="methodMappings">
                    <map>
                        <entry key="spring.application:type=DataSource,name=dataSource"
                               value="getMaxIdle,getMaxActive,getNumIdle,getNumActive"/>
                    </map>
                </property>
            </bean>
        </property>
    </bean>

    <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate" depends-on="flyway">
        <property name="dataSource" ref="dataSource"/>
    </bean>

    <bean id="namedJdbcTemplate" class="org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate">
        <constructor-arg name="classicJdbcTemplate" ref="jdbcTemplate"/>
    </bean>

    <bean id="jdbcPagingListFactory" class="org.cloudfoundry.identity.uaa.resources.jdbc.JdbcPagingListFactory">
        <constructor-arg ref="namedJdbcTemplate"/>
        <constructor-arg ref="limitSqlAdapter"/>
    </bean>

    <bean id="useCaseInsensitiveQueries" class="java.lang.Boolean" factory-method="valueOf">
        <constructor-arg
                value="#{ (@platform eq 'mysql' and '${database.caseinsensitive:true}') ? true : '${database.caseinsensitive:false}'}"/>
    </bean>
</beans>
